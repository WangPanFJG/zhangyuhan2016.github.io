<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mine Clearance 2.0</title>
    <link href="https://cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
    <style>
        body {
            background: #fff5ab;
        }

        td {
            width: 48px;
            height: 48px;
            text-align: center;
            background: #352b32;
            float: left;
            font-size: 0;
        }

        table {
            width: 500px;
        }

        .biao {
            background: url("../public/image/timg.jpg") no-repeat 0px 0px;
        }

        .dian {
            background: #a18d6a;
            font-size: 16px;
        }

        input {
            width: 50px;
        }

        #bang {
            height: 400px;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-color: #ffaf34;
            position: absolute;
            width: 400px;
            text-align: center;
            font-size: 50px;
            font-family: "112452zhang";
            border: 1px solid beige;
            z-index: 2;
            box-shadow: 10px 10px 8px #888888;
        }

        #bang li {
            font-size: 30px;
        }

        #bang li:hover {
            font-size: 32px;
        }

        .mine {
            background: url("../public/image/timg.jpg") no-repeat -49px -49px;
        }
    </style>
</head>
<body>


<div id="mine">
    <p>扫雷&nbsp;Time:&nbsp;{{gameTime}}&nbsp;s</p>
    <button id="mineText" v-on:click="show=!show" v-on:key.enter="show=!show">设置</button>
    <button v-on:click="tan=!tan">排行榜</button>
    <transition
            name="custom-classes-transition"
            enter-active-class="animated bounceInDown"
            leave-active-class="animated bounceOutUp"
    >
        <dialog id="bang" open v-if="tan">
            排行榜
            <ol>
                <li v-for="n of bang" :key="n.id"><span>{{n.name}}</span>&nbsp;&nbsp;<time>{{n.time}}</time>
                </li>
            </ol>
        </dialog>
    </transition>
    <transition
            name="custom-classes-transition"
            enter-active-class="animated bounceInLeft"
            leave-active-class="animated bounceOutRight"
    >
        <article v-if="show">
            <label>格子的数量:</label>
            <input placeholder="格子的数量" v-model="gNum">
            <label>雷的数量:</label>
            <input placeholder="雷的数量" v-model="lNum">
            <button v-on:click="createGame">应用并开始游戏</button>
        </article>
    </transition>
    <table v-bind:style="tableClass" border="1">
        <td v-for="(g,index) of gameGe" :key="g.id" :class="{biao:g.b,dian:g.d}" v-on:mousedown="test(index,$event)">
            <img src="../public/image/timg.jpg" alt="" v-if="g.l&&g.d">
            <span v-if="g.s">{{g.s}}</span>
        </td>
    </table>
</div>

<script src="https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/vue/2.2.1/vue.min.js"></script>
<script>
  /*阻止右键事件冒泡*/
  document.oncontextmenu = function () {
    return false
  }
  var Game = new Vue({
    el: '#mine',
    data: {
      gNum: 81,
      lNum: 9,
      gameGe: [],
      tableClass: {
        width: '0px',
      },
      show: false,
      gameTime: 0,
      t: '',
      tan: false,
      bang: [
        {name: 'Win', time: '12s'},
      ],
      te: false,
    },
    methods: {

      createGame: function () {
        /*初始化*/
        this.show = 0
        this.gameGe = new Array()
        this.gameTime = 0
        this.te = false
        this.tableClass.width = Math.sqrt(this.gNum) * 54 + 'px'
        let rNum = () => Math.floor(Math.random() * this.gNum)
        /*构建雷组*/
        let lArray = new Array()
        for (let a = 0; a < this.lNum; a++) {
          let temp = rNum()
          if (!lArray.includes(temp)) {
            lArray.push(temp)
          } else {
            a--
          }
        }
        /*填充格子*/
        for (let a = 0; a < this.gNum; a++) {
          let temp = lArray.indexOf(a)
          let tempObj = {
            l: 0,
            d: 0,
            b: 0
          }
          if (temp !== -1) {
            /*找到雷*/
            lArray.splice(temp, 1)
            tempObj.l = 1
          }
          this.gameGe.push(tempObj)
        }
        this.createShowNum()
      },
      createShowNum: function () {
        /*为格子添加标记数字*/
        let tempLength = this.gameGe.length
        for (let a = 0; a < tempLength; a++) {
          let tempCNum = 0
          let tempArr = this.x9(a, Math.sqrt(this.gNum), tempLength)
          for (let obj of tempArr) {
            if (this.gameGe[obj].l) {
              tempCNum++
            }
          }
          this.gameGe[a].l === 1 ? this.gameGe[a].s = false : this.gameGe[a].s = tempCNum
        }
      },
      x9: function (n, gNum, pStr) {
        /*九宫寻找术！*/
        let a = parseInt(n - gNum),
          b = parseInt(n + gNum)
        let tempArr = new Array()
        if (n % gNum === 0) {
          tempArr = [a, parseInt(a + 1), n, parseInt(n + 1), b, parseInt(b + 1)]
        } else if (n % gNum === parseInt(gNum - 1)) {
          tempArr = [parseInt(a - 1), a, parseInt(n - 1), n, parseInt(b - 1), b]
        } else {
          tempArr = [parseInt(a - 1), a, parseInt(a + 1), parseInt(n - 1), n, parseInt(n + 1), parseInt(b - 1), b, parseInt(b + 1)]
        }
        let arr = tempArr.filter(function (item) {
          return (item >= 0 && item < parseInt(pStr))
        })
        return arr
      },
      gameWin: function () {
        let qi = $('.biao').length
        let d = $('.dian').length
        if (parseInt(qi) === parseInt(Game.lNum - 1) && parseInt(qi + d) === parseInt(Game.gNum - 1)) {
          clearTimeout(this.t)
          let name = prompt('请输入您的大名', '')
          this.bang.push({name: name === '' ? '匿名' : name, time: this.gameTime + 's'})
          this.createGame()
          this.bang.sort(function (v1, v2) {
            return parseInt(v1.time) - parseInt(v2.time)
          })
          this.tan = true
        }
      },
      gameOver: function () {
        alert('gameOver')
        clearTimeout(this.t)
        this.createGame()
      },
      createTime: function () {
        this.gameTime++
        this.t = setTimeout(Game.createTime, 1000)
      },
      test: function (index, e) {
        let d = this.gameGe[index].d,
          b = this.gameGe[index].b,
          s = this.gameGe[index].s,
          l = this.gameGe[index].l
        if (!this.te) {
          this.createTime()
          this.te = true
        } else if (this.gameTime === 0) {
          this.te = false
        }
        if (e.which === 1) {
          /*点击到空时*/
          if (s === 0) {
            let zeroArr = new Array()
            zeroArr.push(index)
            Tcc(zeroArr)

            function Tcc (arr) {
              /*递归所有s为0的格子并点开*/
              let aLength = zeroArr.length
              arr.forEach(function (item) {
                Game.x9(item, Math.sqrt(Game.gNum), Game.gameGe.length).forEach(function (i) {
                  if (Game.gameGe[i].s === 0 && Game.gameGe[i].b === 0) {
                    if (!zeroArr.includes(i)) {zeroArr.push(i)}
                  } else if (Game.gameGe[i].s < 3 && Game.gameGe[i].b === 0) {
                    /*s<3的格子也点开*/
                    Game.gameGe[i].d = 1
                  }

                })
              })
              let bLength = zeroArr.length
              if (bLength > aLength) {
                Tcc(zeroArr)
              }
            }

            for (let b of zeroArr) {
              Game.gameGe[b].d = 1
            }
          }
          /*点击到已标记的时候*/
          if (b) {
            console.info('已标无法点击')
          } else {
            if (l === 1) {
              this.gameOver()
              return 0
            }
            Game.gameGe[index].d = 1
          }
          this.gameWin()
        } else if (e.which === 3) {
          if (!d) {this.gameGe[index].b = !b}
          this.gameWin()

        }
      },
    },
  })
  Game.createGame()
</script>
</body>
</html>